<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pantanal Clima — Municípios | beta</title>
  <meta name="theme-color" content="#111827"/>
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f172a;
      --card:#111c36;
      --stroke:#233257;
      --txt:#e5e7eb;
      --muted:#a7b0c0;
      --brand:#f97316;
      --brand2:#8b5cf6;
      --ok:#22c55e;
      --bad:#ef4444;
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 700px at 15% 10%, rgba(139,92,246,.18), transparent 65%),
                  radial-gradient(900px 600px at 80% 20%, rgba(249,115,22,.16), transparent 60%),
                  var(--bg);
      color:var(--txt);
    }
    header{
      padding:18px 20px;
      border-bottom:1px solid rgba(255,255,255,.07);
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      position:sticky;
      top:0;
      backdrop-filter: blur(10px);
      background: rgba(11,16,32,.72);
      z-index:1000;
    }
    .brand{
      display:flex; gap:12px; align-items:center;
    }
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: linear-gradient(135deg, rgba(249,115,22,.95), rgba(139,92,246,.95));
      box-shadow: var(--shadow);
    }
    h1{
      font-size:16px;margin:0;letter-spacing:.2px
    }
    .sub{
      font-size:12px;color:var(--muted);margin-top:2px
    }
    .wrap{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:16px;
      padding:16px;
      max-width:1400px;
      margin:0 auto;
    }
    .mapCard, .panel{
      background: linear-gradient(180deg, rgba(17,28,54,.9), rgba(15,23,42,.88));
      border:1px solid rgba(255,255,255,.07);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    #map{height: calc(100vh - 110px); min-height:560px;}
    .panel{ padding:14px; display:flex; flex-direction:column; gap:12px; }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .pill{
      padding:8px 10px; border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: var(--txt);
      font-size:12px;
      display:inline-flex; gap:8px; align-items:center;
    }
    .btn{
      cursor:pointer;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color:var(--txt);
      font-weight:650;
      font-size:12px;
      transition: transform .05s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.16); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ background: linear-gradient(135deg, rgba(249,115,22,.92), rgba(139,92,246,.78)); border-color: rgba(255,255,255,.18); }
    .btn.ghost{ background: rgba(255,255,255,.03); }
    .btn.small{ padding:8px 10px; border-radius: 10px; font-weight:600; }
    .vars{
      display:flex; flex-wrap:wrap; gap:8px;
    }
    .vars .btn.active{
      outline:2px solid rgba(249,115,22,.35);
      background: rgba(249,115,22,.12);
    }
    .kpis{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
    }
    .kpi{
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding:10px 12px;
      min-height:72px;
    }
    .kpi .label{font-size:11px;color:var(--muted)}
    .kpi .val{font-size:18px;font-weight:800;margin-top:4px}
    .kpi .hint{font-size:11px;color:var(--muted);margin-top:2px}
    canvas{ background: rgba(255,255,255,.02); border-radius: 14px; border:1px solid rgba(255,255,255,.08); }
    .footerNote{font-size:11px;color:var(--muted);line-height:1.35}
    .split{height:1px;background:rgba(255,255,255,.07); margin:2px 0;}
    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; }
      #map{ height: 52vh; min-height:360px; }
      .kpis{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
  </style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo" aria-hidden="true"></div>
    <div>
      <h1>Pantanal Clima — Municípios (beta)</h1>
      <div class="sub">Clique no município para abrir o painel • pronto para plugar LULC, IDH, Gini, PIB depois</div>
    </div>
  </div>
  <div class="row">
    <button class="btn primary" id="btnLoadGeo">Carregar municípios (MT/MS)</button>
    <button class="btn ghost" id="btnFit">Enquadrar</button>
  </div>
</header>

<div class="wrap">
  <div class="mapCard">
    <div id="map"></div>
  </div>

  <div class="panel">
    <div class="row" style="justify-content:space-between">
      <div class="pill" id="pillCity">Município: <b>—</b></div>
      <div class="pill" id="pillPeriod">Período: <b>—</b></div>
    </div>

    <div class="kpis">
      <div class="kpi">
        <div class="label">Dias analisados</div>
        <div class="val" id="kpiDays">—</div>
        <div class="hint">agregação diária (por enquanto)</div>
      </div>
      <div class="kpi">
        <div class="label">Tx > 31,5°C</div>
        <div class="val" id="kpiHotDays">—</div>
        <div class="hint">contagem no período</div>
      </div>
      <div class="kpi">
        <div class="label">Noites > 31,5°C</div>
        <div class="val" id="kpiHotNights">—</div>
        <div class="hint">média noturna (19–05)</div>
      </div>
    </div>

    <div class="split"></div>

    <div class="row" style="justify-content:space-between">
      <div class="pill">Variáveis</div>
      <div class="row">
        <button class="btn small" id="btnMonthly">Mensal</button>
        <button class="btn small active" id="btnDaily">Diário</button>
      </div>
    </div>

    <div class="vars" id="vars"></div>

    <canvas id="chart" height="170"></canvas>

    <div class="footerNote" id="note">
      Dica: este é o “motor” do seu painel global. A regra é: <b>município (geojson) → id → JSON do clima</b>.
      Depois a gente encaixa: MapBiomas (LULC), indicadores (IDH/Gini/PIB), saúde, etc.
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
/** ========= Config ========= **/
const STATE_GEOJSON = {
  "MT": "https://raw.githubusercontent.com/tbrugz/geodata-br/master/geojson/geojs-51-mun.json",
  "MS": "https://raw.githubusercontent.com/tbrugz/geodata-br/master/geojson/geojs-50-mun.json",
};
const CITY_CATALOG_URL = "data/cities.json";

/** ========= Helpers ========= **/
function fmt(n, digits=0){
  if(n===null || n===undefined || Number.isNaN(n)) return "—";
  return Number(n).toLocaleString("pt-BR", {maximumFractionDigits: digits, minimumFractionDigits: digits});
}
function groupBy(arr, keyFn){
  const m = new Map();
  for(const x of arr){
    const k = keyFn(x);
    if(!m.has(k)) m.set(k, []);
    m.get(k).push(x);
  }
  return m;
}
function toMonthKey(isoDate){ // "YYYY-MM-DD" -> "YYYY-MM"
  return String(isoDate).slice(0,7);
}
function monthlyAggregate(records, varKey){
  const g = groupBy(records, r => toMonthKey(r.date));
  const out = [];
  for(const [k, rows] of g.entries()){
    const vals = rows.map(r => r[varKey]).filter(v => typeof v === "number" && !Number.isNaN(v));
    if(!vals.length) continue;
    const sum = vals.reduce((a,b)=>a+b, 0);
    const mean = sum / vals.length;
    // For precipitation: sums make more sense. We'll treat keys with "_sum" as sum; others as mean.
    const y = varKey.includes("_sum") ? sum : mean;
    out.push({x: k + "-15", y}); // middle of month for plotting
  }
  out.sort((a,b)=>a.x.localeCompare(b.x));
  return out;
}
function dailySeries(records, varKey){
  const out = records
    .filter(r => typeof r[varKey] === "number" && !Number.isNaN(r[varKey]))
    .map(r => ({x: r.date, y: r[varKey]}));
  return out;
}

/** ========= Map ========= **/
const map = L.map("map", { zoomControl: true }).setView([-16.07, -57.68], 7);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 18, attribution: "&copy; OpenStreetMap"
}).addTo(map);

let geoLayer = null;
let selectedLayer = null;
let catalog = null;

/** ========= UI refs ========= **/
const pillCity = document.getElementById("pillCity");
const pillPeriod = document.getElementById("pillPeriod");
const varsDiv = document.getElementById("vars");
const kpiDays = document.getElementById("kpiDays");
const kpiHotDays = document.getElementById("kpiHotDays");
const kpiHotNights = document.getElementById("kpiHotNights");
const btnLoadGeo = document.getElementById("btnLoadGeo");
const btnFit = document.getElementById("btnFit");
const btnDaily = document.getElementById("btnDaily");
const btnMonthly = document.getElementById("btnMonthly");

let mode = "daily"; // or "monthly"
let activeVarKey = null;
let activeVarLabel = null;
let cityData = null;

/** ========= Chart ========= **/
const ctx = document.getElementById("chart");
const chart = new Chart(ctx, {
  type: "line",
  data: { datasets: [{
    label: "—",
    data: [],
    borderWidth: 2,
    pointRadius: 0,
    tension: 0.2
  }]},
  options: {
    parsing: false,
    responsive: true,
    maintainAspectRatio: false,
    interaction: { mode: "index", intersect: false },
    scales: {
      x: { type: "time", time: { unit: "month" }, ticks: { color: "rgba(229,231,235,.85)" }, grid: { color: "rgba(255,255,255,.06)" } },
      y: { ticks: { color: "rgba(229,231,235,.85)" }, grid: { color: "rgba(255,255,255,.06)" } },
    },
    plugins: {
      legend: { labels: { color: "rgba(229,231,235,.9)" } },
      tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${fmt(c.parsed.y, 2)}` } }
    }
  }
});

// Chart.js time scale needs adapter; simplest: use built-in Date parsing (ISO). We'll set unit dynamically.
Chart.defaults.locale = "pt-BR";

/** ========= Data loading ========= **/
async function loadCatalog(){
  const res = await fetch(CITY_CATALOG_URL);
  if(!res.ok) throw new Error("Falha ao carregar cities.json");
  return await res.json();
}

function setKPIs(records){
  kpiDays.textContent = fmt(records.length, 0);

  const hotDays = records.filter(r => typeof r.t2m_c_max === "number" && r.t2m_c_max > 31.5).length;
  const hotNights = records.filter(r => typeof r.t2m_night_mean_c === "number" && r.t2m_night_mean_c > 31.5).length;

  kpiHotDays.textContent = fmt(hotDays, 0);
  kpiHotNights.textContent = fmt(hotNights, 0);
}

function renderVarButtons(vars){
  varsDiv.innerHTML = "";
  // group by "group"
  const groups = [...new Set(vars.map(v => v.group))];
  for(const g of groups){
    const header = document.createElement("div");
    header.className = "pill";
    header.innerHTML = `<span style="opacity:.85">${g}</span>`;
    varsDiv.appendChild(header);

    for(const v of vars.filter(x => x.group === g)){
      const b = document.createElement("button");
      b.className = "btn small";
      b.textContent = v.label;
      b.dataset.key = v.key;
      b.addEventListener("click", () => selectVariable(v.key, v.label));
      varsDiv.appendChild(b);
    }
  }
}

function setActiveBtn(key){
  [...varsDiv.querySelectorAll("button.btn")].forEach(b => {
    b.classList.toggle("active", b.dataset.key === key);
  });
}

function selectVariable(varKey, label){
  if(!cityData) return;
  activeVarKey = varKey;
  activeVarLabel = label;
  setActiveBtn(varKey);
  redrawChart();
}

function redrawChart(){
  if(!cityData || !activeVarKey) return;

  const records = cityData.data;
  let series = [];
  if(mode === "daily"){
    series = dailySeries(records, activeVarKey);
    chart.options.scales.x.time.unit = "month";
  }else{
    series = monthlyAggregate(records, activeVarKey);
    chart.options.scales.x.time.unit = "year";
  }
  chart.data.datasets[0].label = activeVarLabel;
  chart.data.datasets[0].data = series.map(p => ({x: p.x, y: p.y}));
  chart.update();
}

async function loadCityData(cityId){
  if(!catalog) catalog = await loadCatalog();
  const c = catalog.cities.find(x => x.id === cityId);
  if(!c) throw new Error("Município não encontrado no catálogo: " + cityId);

  const res = await fetch(c.data);
  if(!res.ok) throw new Error("Falha ao carregar JSON do município: " + c.data);
  cityData = await res.json();

  pillCity.innerHTML = `Município: <b>${cityData.city.name} (${cityData.city.uf})</b>`;
  pillPeriod.innerHTML = `Período: <b>${cityData.city.period_start} → ${cityData.city.period_end}</b>`;

  renderVarButtons(cityData.variables);
  setKPIs(cityData.data);

  // default variable
  const defaultVar = cityData.variables.find(v => v.key === "t2m_c_max") || cityData.variables[0];
  selectVariable(defaultVar.key, defaultVar.label);
}

/** ========= GeoJSON loading ========= **/
function styleBase(){
  return { color: "rgba(229,231,235,.55)", weight: 1, fillColor: "rgba(249,115,22,.10)", fillOpacity: 0.18 };
}
function styleHover(){
  return { color: "rgba(249,115,22,.95)", weight: 2, fillColor: "rgba(249,115,22,.22)", fillOpacity: 0.25 };
}
function styleSelected(){
  return { color: "rgba(139,92,246,.95)", weight: 3, fillColor: "rgba(139,92,246,.22)", fillOpacity: 0.28 };
}

function featureName(f){
  // tbrugz geodata-br uses properties.name (name) and properties.description sometimes.
  return (f.properties && (f.properties.name || f.properties.NM_MUN || f.properties.description)) || "—";
}
function featureId(f){
  return (f.properties && (f.properties.id || f.properties.CD_MUN || f.properties.cod_ibge)) || null;
}

async function loadStates(){
  const urls = [STATE_GEOJSON.MT, STATE_GEOJSON.MS];
  const allFeatures = [];
  for(const u of urls){
    const res = await fetch(u);
    if(!res.ok) throw new Error("Falha ao baixar GeoJSON do estado: " + u);
    const gj = await res.json();
    allFeatures.push(...(gj.features || []));
  }
  return { type:"FeatureCollection", features: allFeatures };
}

function attachGeoLayer(featureCollection){
  if(geoLayer) geoLayer.remove();

  geoLayer = L.geoJSON(featureCollection, {
    style: styleBase,
    onEachFeature: (feature, layer) => {
      layer.on("mouseover", () => layer.setStyle(styleHover()));
      layer.on("mouseout", () => {
        if(selectedLayer === layer) layer.setStyle(styleSelected());
        else layer.setStyle(styleBase());
      });
      layer.on("click", async () => {
        if(selectedLayer) selectedLayer.setStyle(styleBase());
        selectedLayer = layer;
        layer.setStyle(styleSelected());
        const name = featureName(feature);
        const id = featureId(feature);

        // For now, we only have Cáceres in the catalog. If user clicks others, we warn.
        if(catalog && catalog.cities.some(c => c.id === String(id))){
          await loadCityData(String(id));
        }else{
          pillCity.innerHTML = `Município: <b>${name}</b>`;
          pillPeriod.innerHTML = `Período: <b>—</b>`;
          varsDiv.innerHTML = `<div class="footerNote">Esse município ainda não tem JSON no catálogo. Assim que você adicionar <b>data/climate/${id}_daily.json</b> e registrar em <b>data/cities.json</b>, ele passa a funcionar.</div>`;
          kpiDays.textContent = "—"; kpiHotDays.textContent = "—"; kpiHotNights.textContent = "—";
          chart.data.datasets[0].label = "—";
          chart.data.datasets[0].data = [];
          chart.update();
        }
      });
      layer.bindTooltip(() => featureName(feature), { sticky:true, opacity:0.95 });
    }
  }).addTo(map);

  map.fitBounds(geoLayer.getBounds(), { padding:[20,20] });
}

/** ========= Events ========= **/
btnLoadGeo.addEventListener("click", async () => {
  btnLoadGeo.disabled = true;
  btnLoadGeo.textContent = "Carregando…";
  try{
    catalog = await loadCatalog();
    const fc = await loadStates();
    attachGeoLayer(fc);

    // auto-select Cáceres if present
    await loadCityData("5102504");
  }catch(err){
    alert(err.message || String(err));
    console.error(err);
  }finally{
    btnLoadGeo.disabled = false;
    btnLoadGeo.textContent = "Carregar municípios (MT/MS)";
  }
});

btnFit.addEventListener("click", () => {
  if(geoLayer) map.fitBounds(geoLayer.getBounds(), { padding:[20,20] });
  else map.setView([-16.07, -57.68], 7);
});

btnDaily.addEventListener("click", () => {
  mode = "daily";
  btnDaily.classList.add("active");
  btnMonthly.classList.remove("active");
  redrawChart();
});
btnMonthly.addEventListener("click", () => {
  mode = "monthly";
  btnMonthly.classList.add("active");
  btnDaily.classList.remove("active");
  redrawChart();
});

// Optional: auto load Cáceres without polygons (fast open)
(async () => {
  try{
    catalog = await loadCatalog();
    await loadCityData("5102504");
  }catch(e){
    // ignore
  }
})();
</script>
</body>
</html>
